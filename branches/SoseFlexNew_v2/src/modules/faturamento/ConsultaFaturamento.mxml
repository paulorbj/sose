<?xml version="1.0" encoding="utf-8"?>
<mx:VBox xmlns:fx="http://ns.adobe.com/mxml/2009" 
		 xmlns:s="library://ns.adobe.com/flex/spark" 
		 xmlns:mx="library://ns.adobe.com/flex/mx"
		 width="100%" height="100%" 
		 verticalGap="0" 
		 xmlns:faturamento="modules.faturamento.*" 
		 xmlns:components="components.*"
		 xmlns:grid="components.grid.*" 
		 xmlns:dc="components.grid.filtros.controles.*"
		 xmlns:combos="components.combos.*">
<!--	creationComplete="configurarSubMenu();"-->
	<fx:Declarations>
		<mx:Fade id="fadeIn" duration="100" alphaFrom="0" alphaTo="1"/>
		<mx:Fade id="fadeOut" duration="100" alphaFrom="1" alphaTo="0"/>
		

		<mx:RemoteObject id="pessoaService" destination="pessoaService" endpoint="{resourceManager.getString('ConfigurationResource','amf')}">			
			<mx:method name="buscarPorId"      
					   fault="onbuscarPorIdFault(event)" 
					   result="onbuscarPorIdResult(event)"
					   />
		</mx:RemoteObject>
		
		
		<mx:RemoteObject id="faturamentoService" destination="faturamentoService" endpoint="{resourceManager.getString('ConfigurationResource','amf')}">			
			<mx:method name="listarFaturasFinalizadasPorDataECliente"      
					   fault="onListarFaturasFinalizadasPorDataEClienteFault(event)" 
					   result="onListarFaturasFinalizadasPorDataEClienteResult(event)"
					   />
		</mx:RemoteObject>
	</fx:Declarations>
	
	<fx:Script>
		<![CDATA[
			import components.messages.MensagemEvent;
			import components.messages.MessageType;
			
			import entities.faturamento.Faturamento;
			
			import modules.view.Login;
			import entities.administrativo.parceiros.Pessoa;

			import mx.collections.ArrayCollection;
			import mx.collections.Sort;
			import mx.collections.SortField;
			import mx.controls.List;
			import mx.events.CloseEvent;
			import mx.events.ListEvent;
			import mx.managers.CursorManager;
			import mx.messaging.events.MessageEvent;
			import mx.rpc.events.FaultEvent;
			import mx.rpc.events.ResultEvent;
			
			
			private var sortListagem:Sort;
			
			private var listaStatusArray:Array = new Array("Pendente", "Faturado", "Todos");
			private var listaStatus:ArrayCollection = new ArrayCollection(listaStatusArray);
			
			[Bindable]
			private var _listaOrdemServico:ArrayCollection;
			
			[Bindable]
			private var _listaFatura:ArrayCollection;
			
			[Bindable]
			public var _fatura:Faturamento;
			
			[Bindable]
			private var _cliente:Pessoa;
			
			[Bindable]
			public var _somatoria:Number;
			
/* 			private function configurarSubMenu():void
			{
				if(Login.currentUser){
					if(!Login.currentUser.perfil.subMenuBaixaFaturamento){
						subMenu.removeChild(baixa);
					}
					if(!Login.currentUser.perfil.subMenuListagemFaturamento){
						subMenu.removeChild(listagem);
					}
				} 
			} */
			
			private function pesquisar(event:MouseEvent):void
			{
				if (cbCliente.clienteSelecionado){
					_cliente = cbCliente.clienteSelecionado as Pessoa;
					
					pessoaService.buscarPorId(_cliente.id);
				}
				if (_cliente){
					faturamentoService.listarFaturasFinalizadasPorDataECliente(_cliente, dataDe.inputDate, dataAte.inputDate);
					
					
				}
				
			}
			
			private function onbuscarPorIdResult(event:ResultEvent = null):void
			{
				_cliente = event.result as Pessoa;
				
			}
			
			private function onbuscarPorIdFault(event:FaultEvent = null):void
			{
				CursorManager.removeAllCursors();
				trace("[ListarContatosFault] [" +	event.fault.faultCode + "] " + event.fault.faultString + " (" +	event.fault.faultDetail + ")");		
				dispatchEvent(new MensagemEvent("Erro ao buscar Pessoa por ID", MessageType.ERROR, 5000));
			}
			
			
			private function onListarFaturasFinalizadasPorDataEClienteResult(event:ResultEvent = null):void
			{
				_listaFatura = event.result as ArrayCollection;
				_somatoria = somaFaturas;
			}
			
			private function onListarFaturasFinalizadasPorDataEClienteFault(event:FaultEvent = null):void
			{
				CursorManager.removeAllCursors();
				trace("[Inicializao do combo cliente] [" +	event.fault.faultCode + "] " + event.fault.faultString + " (" +	event.fault.faultDetail + ")");
				dispatchEvent(new MensagemEvent("Erro ao listar faturas", MessageType.ERROR, 5000));
				
			}
			
/* 			private function initializeListagem():void
			{
				sortListagem = new Sort();
				sortListagem.fields=[new SortField("nomeCliente",false,false,false),new SortField("numeroOrdemServico",false,false,true)];
			}	 */	
			
			private function get totalFaturas():Number
			{
				var total:Number = 0;
				faturamentoService.listarFaturas();
				if(_listaFatura){
					for each(var fat:Faturamento in _listaFatura){
						total = total + fat.totalFatura;
					}
				}
				return total;
			}
			
			//estou pegando o valor de totalFatura (nao tem o frete)
			private function get somaFaturas():Number
			{
				var total:Number = 0;
				
				if(_listaFatura){
					for each(var fat:Faturamento in _listaFatura){
						total = total + fat.totalFatura;
					}
				}
				return total;
			}
		]]>
	</fx:Script>
	

	

			<mx:HBox verticalAlign="middle" width="100%">
				<!--<combos:ComboCheckCliente id="cbcCliente" labelText="Cliente" width="200" required="true"  />-->
				<combos:ComboCliente id="cbCliente"  required="true"  labelText="{resourceManager.getString('ApplicationResource','CLIENTE')}" width="25%" />
				<components:DataInput id="dataDe" required="true" labelText="{resourceManager.getString('ApplicationResource','DATA_DE')}" width="10%" inputHeight="20" />
				<components:DataInput id="dataAte" required="true" labelText="{resourceManager.getString('ApplicationResource','DATA_ATE')}" width="10%" inputHeight="20" />
				<components:ComboBoxInput id="statusFaturamento" required="true" labelText="Status" width="200" dataProvider="{listaStatus}"/>
				<mx:Button id="btPesquisar"
						   label="Pesquisar"
						   height="25"
						   icon="@Embed(source='/assets/icons/user.png')"
						   click="pesquisar(event)"/>
			</mx:HBox>
	
	
			<mx:TitleWindow title="Lista de Faturas - Nº de Faturas: {_listaFatura.length}" width="100%" height="98%" >
				<grid:MantisTable id="viewTable"
								  width="100%"
								  height="100%"
								  draggableColumns="true"
								  dataProvider="{_listaFatura}"
								  doubleClickEnabled="false"
								  >
					<grid:columns>
						
						<!-- CHANGE HERE THE ENTITY COLUMNS -->
						
						<!-- EDIT/REMOVE COLUMNS -->
						
<!--						<mx:DataGridColumn headerText = "{resourceManager.getString('ApplicationResource','ACTION_COLUMN')}"	
										   draggable="false"							 
										   editable="false"
										   sortable="false">
							<mx:itemRenderer>
								<fx:Component>
									<mx:HBox horizontalAlign="center"
											 verticalAlign="middle"
											 >
										
										<mx:Image source="@Embed(source='/assets/icons/edit.png')"
												  click="parentDocument.visualizarDetalhe(data, event)"
												  buttonMode="true"
												  useHandCursor="true"
												  toolTip="{resourceManager.getString('ApplicationResource','EDIT')}"
												  />						
									</mx:HBox>
								</fx:Component>
							</mx:itemRenderer>
						</mx:DataGridColumn>-->
						
						
						<dc:DataGridColumnFilter filterRenderer="components.grid.filtros.DateFilterRenderer" id="dataEmissaoFatura"
												 headerText = "Data emissão"
												 textAlign="center"
												 sortable="false"
												 dataField="dataEmissaoFaturaString"							   
												 />
						
						<dc:DataGridColumnFilter filterRenderer="components.grid.filtros.BeginWithFilterRenderer" id="cliente"
												 headerText = "{resourceManager.getString('ApplicationResource','CLIENTE')}"
												 textAlign="center"
												 sortable="false"
												 dataField="cliente.nomeSistema"							   
												 />
						
						<dc:DataGridColumnFilter filterRenderer="components.grid.filtros.BeginWithFilterRenderer" id="dataCriacao"
												 headerText = "Nº Fatura"
												 textAlign="center"
												 sortable="false"
												 dataField="numeroFatura"							   
												 />
						
						<dc:DataGridColumnFilter id="valor" 
												 headerText = "**Valor"
												 textAlign="center"
												 width="80"
												 dataField = "totalFatura"
												 />
						
						<dc:DataGridColumnFilter filterRenderer="components.grid.filtros.DateFilterRenderer" id="dataVencimentoFatura"
												 headerText = "Data vencimento"
												 textAlign="center"
												 sortable="false"
												 dataField="dataVencimentoFaturaString"							   
												 />
						
						<dc:DataGridColumnFilter filterRenderer="components.grid.filtros.DateFilterRenderer" id="dataPagamentoFatura"
												 headerText = "Data pagamento"
												 textAlign="center"
												 sortable="false"
												 dataField="dataPagamentoFaturaString"							   
												 />
						
					</grid:columns>
				</grid:MantisTable>
			</mx:TitleWindow>

	<mx:HBox paddingTop="10">
		<s:Label text="Somatória das Faturas: R$ {_somatoria}" textAlign="right" fontWeight="bold" fontSize="14"  />
	</mx:HBox>
			<!--<faturamento:DetalhamentoFatura id="detalhamentoFatura" />-->
			
		
		
			
		
			
		
			
	

	
</mx:VBox>
